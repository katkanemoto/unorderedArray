var check = require('check-types');

//walks through the lesson of deleting an existing item in an array
//assumes that the option "index" contains a valid value which to delete
//requires arguments: `UI`, `array`, `arrow` and index
function array_delete(options) {
	if (!(this instanceof array_delete)) return new array_delete(options);
	
	this._state = this._INIT;
	
	//requires arguments
	var validate = require('lib/lesson/util/array_lesson_argument_validate.js');
	var result = validate(options);
	
	if (!result.valid) {
		throw new TypeError(result.msg);
	}
	
	this._UI = options.UI;
	this._array = options.array;
	this._arrow = options.arrow;
	
	if (check.undefined(options.index)) {
		throw new TypeError("Required argument: index, should be an integer index in the array with a valid value at that index");
	}
	this._index = options.index;
	
	this._state = this._READY;
};

array_delete.prototype = {
	//METHODS
	
	next: function() {
		if (this._state === this._INIT) return false;
		
		if (this._state === this._READY) {
			this._state = this._RUN;
			this._step_state = this._STEP_1_STATEMENT;
		}
		
		//statement steps
		if (this._step_state === this._STEP_1_STATEMENT) {
			var output = "For this lesson, we'll be deleting a" + "\n" + 
				"value from an array.";

			this._UI.output.set(output);
			
			this._step_state = this._STEP_2_STATEMENT;
			
			return {value:output, done:false};
		}
		
		if (this._step_state === this._STEP_2_STATEMENT) {
			var output = "First we will remove the value at" + "\n" +
				"index " + String(this._index) + ".";

			this._UI.output.set(output);
			
			this._step_state = this._STEP_3_STATEMENT;
			
			return {value:output, done:false};
		}
		
		if (this._step_state === this._STEP_3_STATEMENT) {
			var output = "Then we will allocate two arrows:" + "\n" +
				"'move_to'" + "\n" +
				"(pointing at the index where we" + "\n" +
				"removed the value)" + "\n" +
				"and 'move_from' (at the next index).";

			this._UI.output.set(output);
			
			this._step_state = this._STEP_4_STATEMENT;
			
			return {value:output, done:false};
		}
		
		if (this._step_state === this._STEP_4_STATEMENT) {
			var output = "Next we will move values from" + "\n" +
			"the index where 'move_from' is" + "\n" +
			"pointing to where 'move_to' is" + "\n" +
			"pointing.";

			this._UI.output.set(output);
			
			this._step_state = this._STEP_5_STATEMENT;
			
			return {value:output, done:false};
		}
		
		if (this._step_state === this._STEP_5_STATEMENT) {
			var output = "Then we will increment both" + "\n" +
			"'move' arrows and continue moving" + "\n" +
			"values in the array until" + "\n" +
			"'move_from' is pointing to the same" + "\n" +
			"index as the 'tail' arrow.";

			this._UI.output.set(output);
			
			this._step_state = this._STEP_6_STATEMENT;
			
			return {value:output, done:false};
		}
		
		if (this._step_state === this._STEP_6_STATEMENT) {
			var output = "We will then remove the 'move'" + "\n" +
			"arrows and move the 'tail' arrow" + "\n" +
			"back one space, producing an" + "\n" +
			"array that is one smaller than the" + "\n" +
			"one we started with by removing" + "\n" +
			"the value at index " + String(this._index) + ".";

			//make room for the additional text on the screen
			this._UI.output.self.y -= 20;
			this._UI.output.set(output);
			
			this._step_state = this._STEP_7_DELETE;
			
			return {value:output, done:false};
		}
		
		//delete value at index
		if (this._step_state === this._STEP_7_DELETE) {
			//correct the positioning of the text output, from the previous step
			this._UI.output.self.y += 20;
			
			var output = "Removing the value at index" + "\n" +
				String(this._index) + ".";
			
			var index = this._index;
			this._array._.pop({index:index});
				
			this._UI.output.set(output);
			
			return {value:output, done:false};
		}
		
		//place copy_to and copy_from arrows
		//check if done
		//if not, then move_within values
		//increment copy arrows
		//check if done
		//loop
		//if done, then prev() tail arrow
		//	& cleanup
	},
	
	//PROPERTIES
	//PRIVATE
	
	//state and constants associated
	_DONE : 3,					//if we can no longer run the lesson, then set this state which makes the lesson unresponsive
	_RUN : 2,					//currently traversing the lesson
	_READY : 1,					//ready to start the lesson, done with all of the setup, not currently in the lesson
	_INIT : 0,					//initial state, setting up object for lesson, should not be able to interact at this step
	_state : undefined,			//tracks the state of the lesson
	
	//states for when stepping through a lesson
	_STEP_7_DELETE		: 6,
	_STEP_6_STATEMENT	: 5,
	_STEP_5_STATEMENT	: 4,
	_STEP_4_STATEMENT	: 3,
	_STEP_3_STATEMENT	: 2,
	_STEP_2_STATEMENT	: 1,
	_STEP_1_STATEMENT	: 0,
	_step_state 		: undefined,
	
	_UI : 			undefined,	//holds a reference to the required argument UI (the proxy to control the UI)
	_array :		undefined,	//holds a reference to the required array (the UI component to traverse during the lesson)
	_arrow :		undefined,	//holds a reference to the required arrow (the "tail" arrow of the array)
};

module.exports = array_delete;