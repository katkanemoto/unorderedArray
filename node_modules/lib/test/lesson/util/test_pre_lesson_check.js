var pre_lesson_check = require('lib/lesson/util/pre_lesson_check.js');
var test = require('tape');
var check = require('check-types');

function SETUP() {
	var lesson_UI = require('lib/UI/lesson_UI');
	var UI = lesson_UI();
	UI.next();	//get the testing lesson_UI into the LESSON state, so that get_proxy() works
	return UI.get_proxy();
}

function TEARDOWN() {
	var primitives = require("lib/util/primitives");
	var stage = primitives.get('stage');
	
	//reset the stage
	stage.clear();
	stage.removeAllChildren();
	
	//delete the text input created by lesson_UI
	var div = document.getElementById('canvas_container');
	//	find the input control
	var input_index;
	for (var i = 0; i < div.children.length; i++) {
		if (div.children[i].type === "text") {
			//don't delete inside the array while iterating over it
			input_index = i;
		}
	};
	
	//if there was a text input, then delete it
	if (input_index) {
		div.removeChild(div.children[input_index]);
	}
	
	//clear the pub sub
	var pub_sub = require('pubsub-js');
	pub_sub.clearAllSubscriptions();
};

TEARDOWN();

test('[pre_lesson_check] incorrect, bad argument', function (t) {
	t.plan(3);
	
	var ui = SETUP();
	
	//TEST
	try {
		pre_lesson_check();
	} catch(error) {
		t.ok(check.instanceStrict(error, TypeError), 'we should get back a TypeError');
		var message = error.toString();
		t.ok(message.match(/Required argument: UI/), 'what was wrong');
		t.ok(message.match(/should be object/), 'how to solve it');
	}
	
	TEARDOWN();
});

test('[pre_lesson_check] correct, bad user input', function (t) {
	//SETUP
	var ui = SETUP();
	ui.input.set(undefined);
	
	//TEST
	var result = pre_lesson_check(ui);
	t.ok(check.undefined(result), "undefined on bad user input");
	
	var output = ui.output.get();
	t.ok(output.match(/not a number/), 'shows what was wrong');
	t.ok(output.match(/Please enter a number/), 'tells you what to enter');
	t.ok(output.match(/the 'Next' button/), '...and what to do');
	
	TEARDOWN();
	t.end();
});

test('[pre_lesson_check] correct', function (t) {
	//SETUP
	var ui = SETUP();
	ui.input.set("0");
	
	//TEST
	var result = pre_lesson_check(ui);
	t.equal(result, 0, "got the input back");
	
	TEARDOWN();
	t.end();
});

//tail