var lesson_UI = require('lib/UI/lesson_UI');
var test = require('tape');
var check = require('check-types');

function SETUP() {
	var primitives = require("lib/util/primitives");
	primitives.set('createjs', createjs);
	
	var canvas = document.getElementsByTagName('canvas')[0];
	var stage = new createjs.Stage(canvas);
	
	primitives.set('stage', stage);
	
	var mock_lib = {
		TitleScreen : function() {
			return {
				insert_btn : {
					addEventListener : function() {},
				},
				gotoAndPlay : function() {},
			};
		},
		ArrayScreen : function() {
			return {};
		},
		ArrayElement : function() {
			var ae = new createjs.Shape();
			ae.index_txt = {
				text : '',
			};
			
			return ae;
		},
	};
	
	primitives.set('lib', mock_lib);
}

function TEARDOWN() {
	var primitives = require("lib/util/primitives");
	primitives.clear();
}

test("[lesson_UI] incorrect, 'stage' wrong type", function (t) {
	t.plan(3);
	
	//SETUP
	SETUP();
	
	var primitives = require("lib/util/primitives");
	primitives.set('stage', '');
	
	//TEST
	try {
		lesson_UI();
	} catch(error) {
		t.ok(check.instanceStrict(error, ReferenceError), 'we should get back a ReferenceError');
		var message = error.toString();
		t.ok(message.match(/stage/), 'checking for an object in primitives');
		t.ok(message.match(/undefined or not object in primitives object/), 'defined what was wrong');
	}
	
	TEARDOWN();
});

test("[lesson_UI] incorrect, 'stage' unset", function (t) {
	t.plan(3);
	
	//SETUP
	SETUP();
	
	var primitives = require("lib/util/primitives");
	primitives.delete('stage');
	
	//TEST
	try {
		lesson_UI();
	} catch(error) {
		t.ok(check.instanceStrict(error, ReferenceError), 'we should get back a ReferenceError');
		var message = error.toString();
		t.ok(message.match(/stage/), 'checking for an object in primitives');
		t.ok(message.match(/undefined or not object in primitives object/), 'defined what was wrong');
	}
	
	TEARDOWN();
});

test("[lesson_UI] incorrect, 'lib' wrong type", function (t) {
	t.plan(3);
	
	//SETUP
	SETUP();
	
	var primitives = require("lib/util/primitives");
	primitives.set('lib', '');
	
	//TEST
	try {
		lesson_UI();
	} catch(error) {
		t.ok(check.instanceStrict(error, ReferenceError), 'we should get back a ReferenceError');
		var message = error.toString();
		t.ok(message.match(/lib/), 'checking for an object in primitives');
		t.ok(message.match(/undefined or not object in primitives object/), 'defined what was wrong');
	}
	
	TEARDOWN();
});

test("[lesson_UI] incorrect, 'lib' unset", function (t) {
	t.plan(3);
	
	//SETUP
	SETUP();
	
	var primitives = require("lib/util/primitives");
	primitives.delete('lib');
	
	//TEST
	try {
		lesson_UI();
	} catch(error) {
		t.ok(check.instanceStrict(error, ReferenceError), 'we should get back a ReferenceError');
		var message = error.toString();
		t.ok(message.match(/lib/), 'checking for an object in primitives');
		t.ok(message.match(/undefined or not object in primitives object/), 'defined what was wrong');
	}
	
	TEARDOWN();
});

test("[lesson_UI] incorrect, 'createjs' wrong type", function (t) {
	t.plan(3);
	
	//SETUP
	SETUP();
	
	var primitives = require("lib/util/primitives");
	primitives.set('createjs', '');
	
	//TEST
	try {
		lesson_UI();
	} catch(error) {
		t.ok(check.instanceStrict(error, ReferenceError), 'we should get back a ReferenceError');
		var message = error.toString();
		t.ok(message.match(/createjs/), 'checking for an object in primitives');
		t.ok(message.match(/undefined or not object in primitives object/), 'defined what was wrong');
	}
	
	TEARDOWN();
});

test("[lesson_UI] incorrect, 'createjs' unset", function (t) {
	t.plan(3);
	
	//SETUP
	SETUP();
	
	var primitives = require("lib/util/primitives");
	primitives.delete('createjs');
	
	//TEST
	try {
		lesson_UI();
	} catch(error) {
		t.ok(check.instanceStrict(error, ReferenceError), 'we should get back a ReferenceError');
		var message = error.toString();
		t.ok(message.match(/createjs/), 'checking for an object in primitives');
		t.ok(message.match(/undefined or not object in primitives object/), 'defined what was wrong');
	}
	
	TEARDOWN();
});

test('[lesson_UI._setup_title_screen] correct', function (t) {
	t.plan(4);
	
	//SETUP
	var mock_lib = {
		TitleScreen : function() {
			return {};
		},
	};
	
	var add_child_called = false;
	var mock_this = {
		_title_screen : undefined,
		_stage : {
			addChild : function() {
				add_child_called = true;
			}
		},
		_lib : mock_lib,
	};
	
	//TEST
	lesson_UI.prototype._setup_title_screen.call(mock_this);
	
	t.ok(check.object(mock_this._title_screen), 'a title screen object was defined');
	t.ok(check.not.undefined(mock_this._title_screen.x), 'defined the x');
	t.ok(check.not.undefined(mock_this._title_screen.y), 'and the y');
	t.ok(add_child_called, 'added the title screen to the stage');
});

test('[lesson_UI._setup_start_button] correct', function (t) {
	t.plan(2);
	
	//SETUP
	var addEventListener_called = false;
	var mock_this = {
		_title_screen : {
			insert_btn : {
				addEventListener : function() {
					addEventListener_called = true;
				},
			},
			
		},
	};
	
	//TEST
	lesson_UI.prototype._setup_start_button.call(mock_this);
	
	t.ok(check.object(mock_this._start_button), 'made a local reference to the inesrt button on the title screen');
	t.ok(addEventListener_called, 'put an event listener on the insert button');
});

test('[lesson_UI._setup_array_screen] correct', function (t) {
	t.plan(3);
	
	//SETUP
	var mock_lib = {
		ArrayScreen : function() {
			return {};
		},
	};
	
	var mock_this = {
		_lib : mock_lib,
	};
	
	//TEST
	lesson_UI.prototype._setup_array_screen.call(mock_this);
	
	t.ok(check.object(mock_this._array_screen), 'made a new array screen object');
	t.ok(check.not.undefined(mock_this._array_screen.x), 'defined the x');
	t.ok(check.not.undefined(mock_this._array_screen.y), 'and the y');
});

test('[lesson_UI] correct', function (t) {
	//SETUP
	var children = [];
	var mock_createjs = {
		Container : function() {
			return {
				children : children,
				addChild : function(child) {
					children.push(child);
				},
				setBounds : function(x, y, width, height) {},
			};
		},
		Text : function() {
			return {
				x : undefined,
				y : undefined,
			};
		},
	};
	var mock_lib = {
		TitleScreen : function() {
			return {
				insert_btn : {
					addEventListener : function() {},
				},
				gotoAndPlay : function() {},
			};
		},
		ArrayScreen : function() {
			return {};
		},
		ArrayElement : function() {
			var ae = new createjs.Shape();
			ae.index_txt = {
				text : '',
			};
			
			return ae;
		},
	};
	var mock_stage = {
		addChild : function() {},
	};
	
	var primitives = require("lib/util/primitives");
	
	primitives.set('createjs', createjs);
	primitives.set('stage', mock_stage);
	primitives.set('lib', mock_lib);
	
	//TEST
	var ui = lesson_UI();
	
	for (property in ui) {
		if (property === "_text_input") {
			t.ok(check.undefined(ui[property]), String(property) + " is undefined until first call of next()");
			continue;
		}
		
		if (property === "_insert_button") {
			t.ok(check.undefined(ui[property]), String(property) + " is undefined until first call of next()");
			continue;
		}
		
		/* if (property === "_tail_arrow") {
			t.ok(check.undefined(ui[property]), String(property) + " is undefined until first call of next()");
			continue;
		} */
		
		if (property === "_next_button") {
			t.ok(check.undefined(ui[property]), String(property) + " is undefined until first call of next()");
			continue;
		}
		
		t.ok(check.not.undefined(ui[property]), String(property) + " is defined");
	}
	
	t.equal(ui._state, ui._PRE_LESSON, 'in the correct state after setup');
	
	TEARDOWN();
	
	t.end();
});

test('[lesson_UI.next] INIT state', function (t) {
	t.plan(6);
	
	//SETUP
	var _title_screen_gotoAndPlay_called = false;
	var _array_screen_gotoAndPlay_called = false;
	var _array_screen_addChild_called = false;
	var _stage_addChild_called = false;
	var next_called = false;
	var mock_this = {
		_INIT : 0,
		_PRE_LESSON : 1,
		_LESSON : 2,
		_state : undefined,
		
		_title_screen : {
			gotoAndPlay : function() {
				_title_screen_gotoAndPlay_called = true;
			},
		},
		next : function() {
			next_called = true;
		},
		_array_screen : {
			gotoAndPlay : function() {
				_array_screen_gotoAndPlay_called = true;
			},
			addChild : function() {
				_array_screen_addChild_called = true;
			},
		},
		_stage : {
			addChild : function() {
				_stage_addChild_called = true;
			},
		},
	};
	mock_this._state = mock_this._INIT;
	
	//TEST
	var result = lesson_UI.prototype.next.call(mock_this);
	
	//should not change state on INIT
	t.notOk(_title_screen_gotoAndPlay_called);
	t.notOk(_array_screen_gotoAndPlay_called);
	t.notOk(_array_screen_addChild_called);
	t.notOk(_stage_addChild_called);
	t.notOk(next_called);
	t.equal(mock_this._state, lesson_UI.prototype._INIT);
});

test('[lesson_UI.next] _PRE_LESSON state', function (t) {
	t.plan(6);
	
	//SETUP
	var _title_screen_gotoAndPlay_called = false;
	var _array_screen_gotoAndPlay_called = false;
	var _array_screen_addChild_called = false;
	var _stage_addChild_called = false;
	var next_called = false;
	var mock_this = {
		_INIT : 0,
		_PRE_LESSON : 1,
		_LESSON : 2,
		_state : undefined,
		
		_title_screen : {
			gotoAndPlay : function() {
				_title_screen_gotoAndPlay_called = true;
			},
		},
		next : function() {
			next_called = true;
		},
		_array_screen : {
			gotoAndPlay : function() {
				_array_screen_gotoAndPlay_called = true;
			},
			addChild : function() {
				_array_screen_addChild_called = true;
			},
		},
		_stage : {
			addChild : function() {
				_stage_addChild_called = true;
			},
		},
		_setup_text_input : function() {},
		_setup_insert_button : function() {},
		_setup_next_button : function() {},
		_setup_tail_arrow : function() {},
		_setup_text_output : function() {},
	};
	mock_this._state = mock_this._LESSON;
	
	//TEST
	var result = lesson_UI.prototype.next.call(mock_this);
	
	t.notOk(_title_screen_gotoAndPlay_called, 'closing the title screen');
	t.ok(_array_screen_gotoAndPlay_called);
	t.ok(_array_screen_addChild_called);
	t.ok(_stage_addChild_called);
	t.notOk(next_called);
	t.equal(mock_this._state, lesson_UI.prototype._LESSON);
});

test('[lesson_UI._setup_text_input] correct', function (t) {
	//SETUP
	SETUP();
	
	var _array_screen_addChild_called = false;
	var mock_this = {
		_array_screen : {
			addChild : function() {
				_array_screen_addChild_called = true;
			},
		},
		_text_input : undefined,
	};
	
	//TEST
	var canvas_container = document.getElementById('canvas_container');
	t.equal(canvas_container.childNodes.length, 3, "this is three for some reason");
	
	lesson_UI.prototype._setup_text_input.call(mock_this);
	
	t.equal(canvas_container.childNodes.length, 4, "then one larger once we add the text input");
	
	t.ok(_array_screen_addChild_called, "added text input to array screen");
	
	t.ok(check.not.undefined(mock_this._text_input), "saw the refrence to the text input");
	
	t.ok(mock_this._text_input.x !== 0, "positioned, x property");
	t.ok(mock_this._text_input.y !== 0, "positioned, y property");
	
	TEARDOWN();
	
	t.end();
});

test('[lesson_UI._setup_text_input -> get] correct', function (t) {
	t.plan(1);
	
	//SETUP
	SETUP();
	
	var mock_this = {
		_array_screen : {
			addChild : function() {},
		},
		_text_input : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_text_input.call(mock_this);
	t.ok(check.function(mock_this._text_input._.get), 'get value should be set');
	
	TEARDOWN();
});

test('[lesson_UI._setup_text_input -> get], correct default', function (t) {
	t.plan(1);
	
	//SETUP
	SETUP();
	
	var mock_this = {
		_array_screen : {
			addChild : function() {},
		},
		_text_input : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_text_input.call(mock_this);
	t.ok(Number.isNaN(mock_this._text_input._.get()), 'the text input should be empty, so an empty string should be NaN');
	
	TEARDOWN();
});

test('[lesson_UI._setup_text_input -> get], correct, number input', function (t) {
	t.plan(1);
	
	//SETUP
	SETUP();
	
	var mock_this = {
		_array_screen : {
			addChild : function() {},
		},
		_text_input : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_text_input.call(mock_this);
	
	mock_this._text_input.children[0].htmlElement.value = 2;
	
	t.equal(mock_this._text_input._.get(), 2, 'should get back 2');
	
	TEARDOWN();
});

test('[lesson_UI._setup_text_input -> get], incorrect, string', function (t) {
	t.plan(1);
	
	//SETUP
	SETUP();
	
	var mock_this = {
		_array_screen : {
			addChild : function() {},
		},
		_text_input : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_text_input.call(mock_this);
	
	mock_this._text_input.children[0].htmlElement.value = 'a';
	
	t.ok(Number.isNaN(mock_this._text_input._.get()), 'shold get back NaN on non-numeric input');
	
	TEARDOWN();
});

test('[lesson_UI._setup_text_input -> get], incorrect, undefined', function (t) {
	t.plan(1);
	
	//SETUP
	SETUP();
	
	var mock_this = {
		_array_screen : {
			addChild : function() {},
		},
		_text_input : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_text_input.call(mock_this);
	
	mock_this._text_input.children[0].htmlElement.value = undefined;
	
	t.ok(Number.isNaN(mock_this._text_input._.get()), 'shold get back NaN on non-numeric input');
	
	TEARDOWN();
});

test('[lesson_UI._setup_text_input -> set], correct', function (t) {
	t.plan(1);
	
	//SETUP
	SETUP();
	
	var mock_this = {
		_array_screen : {
			addChild : function() {},
		},
		_text_input : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_text_input.call(mock_this);
	
	mock_this._text_input._.set('some value');
	
	t.equal(mock_this._text_input.children[0].htmlElement.value, 'some value', "should see 'some value' as the text in the text input");
	
	//t.ok(Number.isNaN(mock_this._text_input._.get_text_input_value()), 'shold get back NaN on non-numeric input');
	
	TEARDOWN();
});

test('[lesson_UI._setup_text_input -> clear], correct', function (t) {
	t.plan(1);
	
	//SETUP
	SETUP();
	
	var mock_this = {
		_array_screen : {
			addChild : function() {},
		},
		_text_input : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_text_input.call(mock_this);
	
	mock_this._text_input.children[0].htmlElement.value = "some mock value";
	mock_this._text_input._.clear();
	
	t.equal(mock_this._text_input.children[0].htmlElement.value, '', "input should be empty after a clear");
	
	TEARDOWN();
});

test('[lesson_UI._setup_insert_button], correct', function (t) {
	t.plan(2);
	
	//SETUP
	SETUP();
	
	var called_addChild = false;
	var mock_this = {
		_array_screen : {
			addChild : function() {
				called_addChild = true;
			},
		},
		_insert_button : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_insert_button.call(mock_this);
	
	t.ok(called_addChild, "added the insert button to the array_screen");
	t.ok(check.object(mock_this._insert_button), "created the insert button");
	
	TEARDOWN();
});

test('[lesson_UI._setup_insert_button], correct, properties set on _insert_button', function (t) {
	t.plan(3);
	
	//SETUP
	SETUP();
	
	var called_addChild = false;
	var mock_this = {
		_array_screen : {
			addChild : function() {
				called_addChild = true;
			},
		},
		_insert_button : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_insert_button.call(mock_this);
	
	t.ok(mock_this._insert_button.x !== 0, "x property set");
	t.ok(mock_this._insert_button.y !== 0, "y property set");
	t.ok(check.object(mock_this._insert_button._.pub_sub), "decorated pub_sub");
	
	TEARDOWN();
});

test('[lesson_UI._setup_insert_button], correct, testing pub_sub', function (t) {
	t.plan(2);
	
	//SETUP
	SETUP();
	
	var called_addChild = false;
	var mock_this = {
		_array_screen : {
			addChild : function() {
				called_addChild = true;
			},
		},
		_insert_button : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_insert_button.call(mock_this);
	
	var pub_sub = mock_this._insert_button._.pub_sub;
	
	pub_sub.subscribe("click", function(msg) {
		t.ok(true, "saw a click event");
		t.equal("click.insert_button", msg, "click event from the insert button");
		
		TEARDOWN();
		pub_sub.clearAllSubscriptions();
	});
	
	mock_this._insert_button.children[0].dispatchEvent(new createjs.Event("click"));
});

test('[lesson_UI._setup_next_button], correct', function (t) {
	t.plan(2);
	
	//SETUP
	SETUP();
	
	var called_addChild = false;
	var mock_this = {
		_array_screen : {
			addChild : function() {
				called_addChild = true;
			},
		},
		_next_button : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_next_button.call(mock_this);
	
	t.ok(called_addChild, "added the next button to the array_screen");
	t.ok(check.object(mock_this._next_button), "created the next button");
	
	TEARDOWN();
});

test('[lesson_UI._setup_next_button], correct, properties set on _insert_button', function (t) {
	t.plan(3);
	
	//SETUP
	SETUP();
	
	var called_addChild = false;
	var mock_this = {
		_array_screen : {
			addChild : function() {
				called_addChild = true;
			},
		},
		_next_button : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_next_button.call(mock_this);
	
	t.ok(mock_this._next_button.x !== 0, "x property set");
	t.ok(mock_this._next_button.y !== 0, "y property set");
	t.ok(check.object(mock_this._next_button._.pub_sub), "decorated pub_sub");
	
	TEARDOWN();
});

test('[lesson_UI._setup_next_button], correct, testing pub_sub', function (t) {
	t.plan(2);
	
	//SETUP
	SETUP();
	
	var called_addChild = false;
	var mock_this = {
		_array_screen : {
			addChild : function() {
				called_addChild = true;
			},
		},
		_next_button : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_next_button.call(mock_this);
	
	var pub_sub = mock_this._next_button._.pub_sub;
	
	pub_sub.subscribe("click", function(msg) {
		t.ok(true, "saw a click event");
		t.equal("click.next_button", msg, "click event from the next button");
		
		TEARDOWN();
		pub_sub.clearAllSubscriptions();
	});
	
	mock_this._next_button.children[0].dispatchEvent(new createjs.Event("click"));
});

test('[lesson_UI._setup_text_output], correct', function (t) {
	t.plan(8);
	
	//SETUP
	SETUP();
	
	var called_addChild = false;
	var mock_this = {
		_array_screen : {
			addChild : function() {
				called_addChild = true;
			},
		},
		_next_button : {
			x : 0,
			y : 1,
			getBounds : function() {
				return {
					height : 1,
				};
			}
		},
		_text_output : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_text_output.call(mock_this);
	
	t.ok(called_addChild, "added to array_screen");
	t.ok(check.instanceStrict(mock_this._text_output, createjs.Text), "should get back a Text object");
	t.ok(mock_this._text_output.x !== 0, "should be positioned, x");
	t.ok(mock_this._text_output.y !== 0, "should be positioned, y");
	t.ok(check.object(mock_this._text_output._), "should have the '_' namespace");
	t.ok(check.function(mock_this._text_output._.set), "decorated convenience method, set");
	t.ok(check.function(mock_this._text_output._.get), "decorated convenience method, get");
	t.ok(check.function(mock_this._text_output._.clear), "decorated convenience method, clear");
	
	TEARDOWN();
});

test('[lesson_UI._setup_text_output -> methods], correct', function (t) {
	t.plan(3);
	
	//SETUP
	SETUP();
	
	var called_addChild = false;
	var mock_this = {
		_array_screen : {
			addChild : function() {
				called_addChild = true;
			},
		},
		_next_button : {
			x : 0,
			y : 1,
			getBounds : function() {
				return {
					height : 1,
				};
			}
		},
		_text_output : undefined,
	};
	
	//TEST
	lesson_UI.prototype._setup_text_output.call(mock_this);
	
	mock_this._text_output.text = "some string";
	
	t.equal(mock_this._text_output._.get(), "some string", "get() works");
	
	mock_this._text_output._.set('some other string');
	
	t.equal(mock_this._text_output._.get(), 'some other string', "set() works");
	
	mock_this._text_output._.clear();
	
	t.equal(mock_this._text_output._.get(), '', "clear() works");
	
	TEARDOWN();
});

test('[lesson_UI._setup_array] correct', function (t) {
	//SETUP
	
	SETUP();
	
	var mock_this = {};
	
	//TEST
	lesson_UI.prototype._setup_array.call(mock_this);
	
	t.ok(check.object(mock_this._array), 'made a new array object');
	t.ok(check.object(mock_this._tail_arrow), 'made a new arrow object');
	t.ok(check.not.undefined(mock_this._array.x), 'defined the x');
	t.ok(check.not.undefined(mock_this._array.y), 'and the y');
	
	TEARDOWN();
	
	t.end();
});